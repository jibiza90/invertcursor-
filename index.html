<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PORTFOLIO MANAGER | Premium Investment Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/app.css?v=3">
    <link rel="stylesheet" href="static/animations.css?v=3">
    <link rel="stylesheet" href="static/loading.css?v=2.9.16">
    <link rel="stylesheet" href="static/virtual-scroll.css?v=1">
    <link rel="stylesheet" href="static/incremental-controls.css?v=1">
    <link rel="stylesheet" href="reports-styles.css?v=1">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüíé%3C/text%3E%3C/svg%3E">
</head>
<body>
    <!-- Indicador de carga global -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="loading-text">Cargando Portfolio Manager...</div>
            <div id="loadingProgress" class="loading-progress" style="display: none;">
                <div class="progress-text"></div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="progress-time"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>PORTFOLIO MANAGER <span style="font-size: 0.5em; color: #888; font-weight: 400;">V2.9.27</span></h1>
            <div class="header-actions">
                <select id="selectorHoja" class="selector-hoja">
                    <option value="Diario STD">Diario STD</option>
                    <option value="Diario VIP">Diario VIP</option>
                    <option value="Diario WIND" selected>Diario WIND</option>
                    <option value="Diario Xavi">Diario Xavi</option>
                </select>
                <select id="selectorMes" class="selector-mes">
                    <option value="">-- Mes --</option>
                </select>
                <div class="mes-nav">
                    <button id="btnMesAnterior" class="btn btn-secondary btn-mes">Mes anterior</button>
                    <button id="btnMesSiguiente" class="btn btn-secondary btn-mes">Mes siguiente</button>
                </div>
                <select id="selectorCliente" class="selector-cliente">
                    <option value="">-- Selecciona un Cliente --</option>
                </select>
                <button id="btnUndo" class="btn btn-secondary" title="Deshacer (Ctrl+Z)">‚Ü© Atr√°s</button>
                <button id="btnRedo" class="btn btn-secondary" title="Rehacer (Ctrl+Y)">‚Ü™ Rehacer</button>
                <button id="btnActualizarTodo" class="btn btn-accent" title="Recalcular todas las casillas">‚ü≥ Actualizar</button>
                <button id="btnGuardar" class="btn btn-primary">Guardar Cambios</button>
                <button id="btnExportar" class="btn btn-secondary">Exportar JSON</button>
            </div>
        </header>

        <div class="main-content">
            <!-- Panel de navegaci√≥n -->
            <aside class="sidebar">
                <h2>Navegaci√≥n</h2>
                <div class="nav-menu">
                    <button class="nav-btn active" data-vista="general" id="btnVistaGeneral">
                        Vista General
                    </button>
                    <button class="nav-btn" data-vista="clientes" id="btnVistaClientes">
                        Clientes
                    </button>
                    <button class="nav-btn" data-vista="infoClientes" id="btnVistaInfoClientes">
                        Info Clientes
                    </button>
                    <button class="nav-btn" data-vista="comision" id="btnVistaComision">
                        Comisi√≥n
                    </button>
                    <button class="nav-btn" data-vista="estadisticas" id="btnVistaEstadisticas">
                        üìä Estad√≠sticas
                    </button>
                    <button class="nav-btn" data-vista="reports" id="btnVistaReports">
                        üìÑ Informes
                    </button>
                </div>
                
                <!-- B√∫squeda de clientes (solo visible en vista clientes) -->
                <div class="search-box" id="busquedaClientes" style="display: none;">
                    <input type="text" id="buscarClienteSidebar" placeholder="üîç Buscar cliente...">
                </div>
                <div class="client-list" id="listaClientes" style="display: none;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </aside>

            <!-- √Årea principal -->
            <main class="content-area">
                <!-- Vista General -->
                <div id="vistaGeneral" class="view active">
                    <div class="view-header-premium">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <h2>Resumen del Portafolio</h2>
                            <button id="btnLimpiarFiltro" class="btn btn-secondary" style="background: linear-gradient(135deg, #ff9a56 0%, #ff7e5f 100%); color: white; border: none;">Limpiar datos</button>
                        </div>
                        <div class="filters-bar">
                            <div class="filter-group">
                                <label>Desde:</label>
                                <input type="date" id="fechaDesde" class="date-filter">
                            </div>
                            <div class="filter-group">
                                <label>Hasta:</label>
                                <input type="date" id="fechaHasta" class="date-filter">
                            </div>
                            <button id="btnAplicarFiltro" class="btn btn-primary">Aplicar Filtro</button>
                            <button id="btnLimpiarFiltroFechas" class="btn btn-secondary">Limpiar filtro</button>
                            <button id="btnToggleVista" class="btn btn-secondary">Ver Resumen</button>
                        </div>
                    </div>
                    
                    <div class="summary-cards-premium" id="summaryCards">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                    
                    <div class="table-container-premium" id="tablaGeneralContainer">
                        <table id="tablaGeneral" class="data-table">
                            <thead id="theadGeneral">
                                <!-- Se llenar√° din√°micamente -->
                            </thead>
                            <tbody id="tbodyGeneral">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vista Clientes (Lista) -->
                <div id="vistaClientes" class="view">
                    <div class="view-header">
                        <button id="btnVolverGeneralDesdeClientes" class="btn btn-primary">üè† Vista General</button>
                        <h2>Lista de Clientes</h2>
                    </div>
                    <div class="clientes-toolbar">
                        <div class="clientes-toolbar-left">
                            <select id="selectorPlantillaCliente" class="selector-cliente">
                                <option value="">Plantilla: √∫ltimo cliente</option>
                            </select>
                            <button id="btnAgregarCliente" class="btn btn-accent">Ôºã Agregar nuevo cliente</button>
                            <input id="buscarCliente" class="selector-cliente clientes-search-input" type="text" placeholder="Buscar cliente...">
                        </div>
                        <div class="clientes-toolbar-right">
                            <label for="ordenClientes" class="stat-label">Ordenar</label>
                            <select id="ordenClientes" class="selector-cliente">
                                <option value="numero_asc">N√∫mero: Menor a mayor</option>
                                <option value="numero_desc">N√∫mero: Mayor a menor</option>
                                <option value="saldo_desc">Saldo: Mayor a menor</option>
                                <option value="saldo_asc">Saldo: Menor a mayor</option>
                                <option value="comision_desc">Comisi√≥n (si retira): Mayor a menor</option>
                                <option value="comision_asc">Comisi√≥n (si retira): Menor a mayor</option>
                                <option value="garantia_desc">Garant√≠a: Mayor a menor</option>
                                <option value="garantia_asc">Garant√≠a: Menor a mayor</option>
                            </select>
                        </div>
                    </div>
                    <div class="stats-bar">
                        <div class="stat">
                            <span class="stat-label">Total Clientes:</span>
                            <span class="stat-value" id="totalClientes">0</span>
                        </div>
                    </div>
                    <div class="summary-cards-premium" id="clientesKpis"></div>
                    <div class="clientes-cards-grid" id="clientesCards"></div>
                </div>

                <!-- Vista Detalle Cliente -->
                <div id="vistaDetalle" class="view">
                    <div class="view-header">
                        <button id="btnVolver" class="btn btn-back">‚Üê Volver</button>
                        <button id="btnVolverGeneral" class="btn btn-primary" style="margin-left: 10px;">üè† Vista General</button>
                        <button id="btnEliminarCliente" class="btn btn-danger" style="margin-left: 10px;">üóë Eliminar cliente</button>
                        <button id="btnEstadisticasCliente" class="btn btn-stats-client" style="margin-left: 10px;">üìä Estad√≠sticas del Cliente</button>
                        <h2 id="tituloCliente">Cliente <span id="numeroCliente">1</span></h2>
                    </div>
                    
                    <!-- Resumen de c√°lculos del cliente (oculto por defecto) -->
                    <div class="client-summary" id="resumenCliente" style="display: none;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                    
                    <!-- Tabla con datos editables -->
                    <div class="table-container table-container-scroll">
                        <table id="tablaDetalle" class="data-table editable-table">
                            <thead id="theadDetalle">
                                <!-- Se llenar√° din√°micamente -->
                            </thead>
                            <tbody id="tbodyDetalle">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vista Info Clientes -->
                <div id="vistaInfoClientes" class="view">
                    <div class="view-header-premium">
                        <h2>Informaci√≥n de Clientes</h2>
                        <div class="info-clientes-controls">
                            <input type="text" id="buscarInfoCliente" placeholder="üîç Buscar cliente..." class="search-input">
                            <div class="tabs-container">
                                <button class="tab-btn active" data-hoja="Diario STD" id="tabSTD">Diario STD</button>
                                <button class="tab-btn" data-hoja="Diario VIP" id="tabVIP">Diario VIP</button>
                                <button class="tab-btn" data-hoja="Diario WIND" id="tabWIND">Diario WIND</button>
                                <button class="tab-btn" data-hoja="Diario Xavi" id="tabXavi">Diario Xavi</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-clientes-container" id="infoClientesContainer">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <!-- Vista Comisi√≥n -->
                <div id="vistaComision" class="view">
                    <div class="view-header-premium">
                        <div class="view-header-left">
                            <h2>C√°lculo de Comisiones</h2>
                            <input type="text" id="buscarComision" placeholder="üîç Buscar cliente..." class="search-input">
                        </div>
                        <div class="tabs-container">
                            <button class="tab-btn active" data-hoja="Diario STD" id="tabSTDComision">Diario STD</button>
                            <button class="tab-btn" data-hoja="Diario VIP" id="tabVIPComision">Diario VIP</button>
                            <button class="tab-btn" data-hoja="Diario WIND" id="tabWINDComision">Diario WIND</button>
                            <button class="tab-btn" data-hoja="Diario Xavi" id="tabXaviComision">Diario Xavi</button>
                        </div>
                    </div>
                    
                    <div class="comision-container" id="comisionContainer">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <!-- Vista Estad√≠sticas -->
                <div id="vistaEstadisticas" class="view">
                    <div class="view-header-premium">
                        <div class="view-header-left">
                            <h2>üìä Estad√≠sticas de Rentabilidad</h2>
                        </div>
                        <div class="tabs-container">
                            <button class="tab-btn active" data-hoja="Diario STD" id="tabSTDStats">Diario STD</button>
                            <button class="tab-btn" data-hoja="Diario VIP" id="tabVIPStats">Diario VIP</button>
                            <button class="tab-btn" data-hoja="Diario WIND" id="tabWINDStats">Diario WIND</button>
                            <button class="tab-btn" data-hoja="Diario Xavi" id="tabXaviStats">Diario Xavi</button>
                        </div>
                    </div>
                    
                    <div class="estadisticas-container" id="estadisticasContainer">
                        <!-- Controles Premium -->
                        <div class="chart-controls-premium">
                            <div class="control-group">
                                <label>Tipo de gr√°fico:</label>
                                <select id="tipoGrafico">
                                    <option value="bar" selected>Barras</option>
                                    <option value="line">L√≠nea</option>
                                    <option value="radar">Radar</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Periodo:</label>
                                <select id="periodoStats">
                                    <option value="all" selected>Todo el a√±o</option>
                                    <option value="12">√öltimos 12 meses</option>
                                    <option value="6">√öltimos 6 meses</option>
                                    <option value="3">√öltimos 3 meses</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Vista:</label>
                                <div class="toggle-group">
                                    <button class="toggle-btn active" id="btnVistaMensual">Mensual</button>
                                    <button class="toggle-btn" id="btnVistaAcumulado">Acumulado</button>
                                </div>
                            </div>
                            <div class="control-group">
                                <label>Benchmark:</label>
                                <input type="number" id="benchmarkInput" value="2" min="0" max="10" step="0.1" style="width:60px"> %/mes
                            </div>
                            <button class="btn-export" id="btnExportarGrafico" title="Exportar como imagen">
                                üì• Exportar
                            </button>
                        </div>

                        <!-- Gr√°fico Principal -->
                        <div class="chart-wrapper-premium">
                            <canvas id="chartRentabilidad"></canvas>
                        </div>

                        <!-- Resumen de KPIs -->
                        <div class="stats-summary-premium" id="statsSummary">
                            <!-- Se llenar√° din√°micamente -->
                        </div>

                        <!-- Indicadores Avanzados -->
                        <div class="stats-indicators" id="statsIndicators">
                            <!-- Se llenar√° din√°micamente -->
                        </div>

                        <!-- Tabla Detallada -->
                        <div class="stats-table-container">
                            <h3>üìã Detalle Mensual</h3>
                            <table class="stats-table" id="statsTable">
                                <thead>
                                    <tr>
                                        <th>Mes</th>
                                        <th>Rentabilidad</th>
                                        <th>Acumulado</th>
                                        <th>vs Benchmark</th>
                                        <th>Tendencia</th>
                                    </tr>
                                </thead>
                                <tbody id="statsTableBody">
                                    <!-- Se llenar√° din√°micamente -->
                                </tbody>
                            </table>
                        </div>


                        <!-- Proyecci√≥n -->
                        <div class="stats-projection" id="statsProjection">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Vista Informes -->
                <div id="vistaReports" class="view">
                    <div class="reports-header">
                        <h1><i class="fas fa-file-pdf"></i> Informes de Clientes</h1>
                        <p>Genera informes PDF detallados para cada cliente con estad√≠sticas completas</p>
                    </div>

                    <!-- Selecci√≥n de Cliente -->
                    <div class="client-selection-container">
                        <h3 class="client-selection-title">
                            <i class="fas fa-users"></i> Seleccionar Cliente
                        </h3>
                        <select id="reportClientSelect" class="client-dropdown">
                            <option value="">Selecciona un cliente...</option>
                        </select>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="generateReportBtn" class="generate-report-btn" disabled>
                                <i class="fas fa-file-pdf"></i> Generar Informe PDF
                            </button>
                            <button id="reloadClientsBtn" class="generate-report-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-sync-alt"></i> Recargar Clientes
                            </button>
                        </div>
                    </div>

                    <!-- Historial de Informes -->
                    <div class="reports-history-container">
                        <h3 class="reports-history-title">
                            <i class="fas fa-history"></i> Informes Recientes
                        </h3>
                        <ul id="reportsHistoryList" class="reports-list">
                            <li class="empty-state">
                                <div class="empty-state-icon">üìÑ</div>
                                <div class="empty-state-text">No hay informes generados</div>
                                <div class="empty-state-subtext">Selecciona un cliente y genera tu primer informe</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal de confirmaci√≥n -->
        <div id="modalConfirmacion" class="modal">
            <div class="modal-content">
                <h3>Confirmar Cambios</h3>
                <p>¬øEst√°s seguro de que quieres guardar los cambios?</p>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="confirmarGuardar">S√≠, Guardar</button>
                    <button class="btn btn-secondary" id="cancelarGuardar">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Notificaci√≥n -->
        <div id="notificacion" class="notificacion"></div>
    </div>

    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Librer√≠as para generaci√≥n de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- M√≥dulos de utilidades -->
    <script src="js/utils/fechas.js?v=2.9.18"></script>
    <script src="js/utils/numeros.js?v=2.9.18"></script>
    <script src="js/core/calculadora.js?v=2.9.18"></script>
    
    <!-- Optimizaciones de rendimiento -->
    <script src="static/cache-manager.js?v=1"></script>
    <script src="static/render-optimizer.js?v=1"></script>
    <script src="static/virtual-scroll.js?v=1"></script>
    <script src="static/incremental-updater.js?v=1"></script>
    <script src="static/incremental-controls.js?v=1"></script>
    
    <!-- Web Workers -->
    <script>
        // Inicializar Web Worker para c√°lculos pesados
        let calculationsWorker = null;
        
        function initCalculationsWorker() {
            if (typeof Worker !== 'undefined') {
                calculationsWorker = new Worker('static/calculations-worker.js?v=1');
                
                calculationsWorker.onmessage = function(e) {
                    const { type, result, error } = e.data;
                    
                    if (error) {
                        console.error('Error en Web Worker:', error);
                        return;
                    }
                    
                    // Manejar resultados del worker
                    switch(type) {
                        case 'recalcularSaldos':
                            window.handleWorkerSaldos?.(result);
                            break;
                        case 'calcularEstadisticas':
                            window.handleWorkerEstadisticas?.(result);
                            break;
                        case 'procesarDatosCliente':
                            window.handleWorkerCliente?.(result);
                            break;
                    }
                };
                
                console.log('üöÄ Web Worker de c√°lculos inicializado');
            } else {
                console.warn('‚ö†Ô∏è Web Workers no soportados');
            }
        }
        
        // Inicializar al cargar la p√°gina
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCalculationsWorker);
        } else {
            initCalculationsWorker();
        }
    </script>
    
    <!-- M√≥dulo de informes (cargar antes que app.js) -->
    <script src="reports.js?v=6"></script>
    
    <!-- Aplicaci√≥n principal -->
    <script src="app.js?v=2.9.35"></script>
    <script src="test_recalculo.js?v=2.9.18"></script>
</body>
</html>
